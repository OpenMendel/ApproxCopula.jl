---
title: "negativebinomial_qc_vs_lme4_glmer"
author: "sarah"
date: "10/26/2021"
output:
  pdf_document: default
  html_document: default
geometry: margin = 1cm
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("lme4")
library("glmmTMB")
```

```{r, echo = FALSE}
data = read.csv("/Users/sarahji/.julia/dev/GLMCopula/test/estimation/2_vcm/mse_nb_vcm/NB_vs_lme4/N10k_ni5_NB.csv", header = TRUE)
```

I simulated a single dataset with sample size 10,000 and cluster size 5 under our negative binomial random intercept GLMM with $\beta \sim$ Uniform(-0.2, 0.2), single variance component Sigma = 0.01 and r = 10. Here I compare the fit of our NB regression with two most popular R packages for fitting Negative Binomial GLMM's with options to estimate "r":
  
  1. lme4: The function glmer.nb estimates r pretty well, but very slowly. To get confidence intervals, it takes a significant amount of additional time, but no inference on r.
  2. glmmTMB: The function glmmTMB estimates r pretty well and a little faster than lme4 but still slow. We can get the CI for all parameters in much less time than lme4.

\newpage


# lme4: glmer.nb
```{r, warning= FALSE}
# Start the clock!
ptm <- proc.time()
m.nb <- glmer.nb(Y ~ 1 + X2 + X3 + (1|group), data = data, verbose = TRUE)
# Stop the clock
proc.time() - ptm
```

### Show estimates
```{r}
m.nb
```

### Show estimated r from lme4: glmer.nb
```{r}
getME(m.nb, "glmer.nb.theta")
```

### Show confidence intervals from lme4: glmer.nb
```{r}
ptm <- proc.time()
confint(m.nb)
# Stop the clock
proc.time() - ptm
```

\newpage

# glmmTMB: glmmTMB

```{r, warning=FALSE}
# Start the clock!
ptm <- proc.time()
m.glmmtmb_nb <- glmmTMB(Y ~ 1 + X2 + X3 + (1|group), data = data, family=nbinom2)
# Stop the clock
proc.time() - ptm
```

### Show estimates
```{r}
m.glmmtmb_nb
```

### Show estimated r from glmmTMB
```{r}
sigma(m.glmmtmb_nb)
```

### Show confidence intervals from glmmTMB
```{r}
ptm <- proc.time()
confint(m.glmmtmb_nb, full = TRUE)
# Stop the clock
proc.time() - ptm
```

